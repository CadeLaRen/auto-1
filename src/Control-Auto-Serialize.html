<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Control/Auto/Serialize.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- |</span>
<a name="line-4"></a><span class='hs-comment'>-- Module      : Control.Auto.Serialize</span>
<a name="line-5"></a><span class='hs-comment'>-- Description : Serializing and deserializing 'Auto's to and from disk,</span>
<a name="line-6"></a><span class='hs-comment'>--               and also 'Auto' transformers focused around serialization.</span>
<a name="line-7"></a><span class='hs-comment'>-- Copyright   : (c) Justin Le 2015</span>
<a name="line-8"></a><span class='hs-comment'>-- License     : MIT</span>
<a name="line-9"></a><span class='hs-comment'>-- Maintainer  : justin@jle.im</span>
<a name="line-10"></a><span class='hs-comment'>-- Stability   : unstable</span>
<a name="line-11"></a><span class='hs-comment'>-- Portability : portable</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-- This module provides tools for working with the automatically derived</span>
<a name="line-14"></a><span class='hs-comment'>-- serializability and resumability of 'Auto's.  The first half contains</span>
<a name="line-15"></a><span class='hs-comment'>-- boring wrappers around encoding and decoding to and from binary,</span>
<a name="line-16"></a><span class='hs-comment'>-- filepaths on disk, etc.</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- The second half contains 'Auto' transformers that "imbue" an 'Auto' with</span>
<a name="line-19"></a><span class='hs-comment'>-- IO serialization abilities.  Note that these all require an underlying</span>
<a name="line-20"></a><span class='hs-comment'>-- 'Monad' that is an instance of 'MonadIO'.</span>
<a name="line-21"></a><span class='hs-comment'>--</span>
<a name="line-22"></a><span class='hs-comment'>-- You have "identity-like" transformers that take an 'Auto' and spit it</span>
<a name="line-23"></a><span class='hs-comment'>-- back out operationally unchanged...but every step, it might do some</span>
<a name="line-24"></a><span class='hs-comment'>-- behind-the-scenes saving or re-load itself from disk when it is first</span>
<a name="line-25"></a><span class='hs-comment'>-- stepped.  Or you have some "trigger enhancers" that take normal 'Auto's</span>
<a name="line-26"></a><span class='hs-comment'>-- and give you the ability to "trigger" saving and loading events on the</span>
<a name="line-27"></a><span class='hs-comment'>-- 'Auto' using the 'Blip' mechanisms and blip stream semantics from</span>
<a name="line-28"></a><span class='hs-comment'>-- "Control.Auto.Blip".</span>
<a name="line-29"></a><span class='hs-comment'>--</span>
<a name="line-30"></a><span class='hs-comment'>-- Note that the entire 'Auto' construct is a little bit awkward when it</span>
<a name="line-31"></a><span class='hs-comment'>-- comes to performing IO effects --- it isn't exactly what they were</span>
<a name="line-32"></a><span class='hs-comment'>-- designed for originally.  Hooking on effects to stepping can be</span>
<a name="line-33"></a><span class='hs-comment'>-- powerful, but as of now, not much has been looked into meaningful error</span>
<a name="line-34"></a><span class='hs-comment'>-- handling when working with IO.  If you have any experience with this and</span>
<a name="line-35"></a><span class='hs-comment'>-- are willing to help, please feel free to send me an e-mail or open an</span>
<a name="line-36"></a><span class='hs-comment'>-- issue on the &lt;https://github.com/mstksg/auto/issues issue tracker&gt;!</span>
<a name="line-37"></a><span class='hs-comment'>--</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialize</span> <span class='hs-layout'>(</span>
<a name="line-40"></a>  <span class='hs-comment'>-- * Serializing and deserializing 'Auto's</span>
<a name="line-41"></a>  <span class='hs-comment'>-- ** To and from "Data.Serialize" types</span>
<a name="line-42"></a>    <span class='hs-varid'>saveAuto</span>
<a name="line-43"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>resumeAuto</span>
<a name="line-44"></a>  <span class='hs-comment'>-- ** To and from binary</span>
<a name="line-45"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>encodeAuto</span>
<a name="line-46"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>decodeAuto</span>
<a name="line-47"></a>  <span class='hs-comment'>-- ** To and from disk</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>writeAuto</span>
<a name="line-49"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>readAuto</span>
<a name="line-50"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>readAutoDef</span>
<a name="line-51"></a>  <span class='hs-comment'>-- * Imbuing 'Auto's with serialization</span>
<a name="line-52"></a>  <span class='hs-comment'>-- ** Implicit automatic serialization</span>
<a name="line-53"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>saving</span>
<a name="line-54"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loading'</span>
<a name="line-55"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loading</span>
<a name="line-56"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>serializing'</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>serializing</span>
<a name="line-58"></a>  <span class='hs-comment'>-- ** Triggered (blip stream-based) automatic serialization</span>
<a name="line-59"></a>  <span class='hs-comment'>-- $onfrom</span>
<a name="line-60"></a>  <span class='hs-comment'>-- *** External triggering</span>
<a name="line-61"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>saveOnB</span>
<a name="line-62"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loadOnB'</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loadOnB</span>
<a name="line-64"></a>  <span class='hs-comment'>-- *** Intrinsic triggering</span>
<a name="line-65"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>saveFromB</span>
<a name="line-66"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loadFromB'</span>
<a name="line-67"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loadFromB</span>
<a name="line-68"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Blip</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>  <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-79"></a>
<a name="line-80"></a><a name="readAuto"></a><span class='hs-comment'>-- | Give a 'FilePath' and an 'Auto', and 'readAuto' will attempt to resume</span>
<a name="line-81"></a><span class='hs-comment'>-- the saved state of the 'Auto' from disk, reading from the given</span>
<a name="line-82"></a><span class='hs-comment'>-- 'FilePath'.  Will return 'Left' upon a decoding error, with the error,</span>
<a name="line-83"></a><span class='hs-comment'>-- and 'Right' if the decoding is succesful.</span>
<a name="line-84"></a><span class='hs-definition'>readAuto</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>        <span class='hs-comment'>-- ^ filepath to read from</span>
<a name="line-85"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>      <span class='hs-comment'>-- ^ 'Auto' to resume</span>
<a name="line-86"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-definition'>readAuto</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decodeAuto</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>readFile</span> <span class='hs-varid'>fp</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="readAutoDef"></a><span class='hs-comment'>-- | Like 'readAuto', but will return the /original/ 'Auto' (instead of</span>
<a name="line-90"></a><span class='hs-comment'>-- a resumed one) if the file does not exist.</span>
<a name="line-91"></a><span class='hs-comment'>--</span>
<a name="line-92"></a><span class='hs-comment'>-- Useful if you want to "resume an 'Auto'" "if there is" a save state, or</span>
<a name="line-93"></a><span class='hs-comment'>-- just use it as-is if there isn't.</span>
<a name="line-94"></a><span class='hs-definition'>readAutoDef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>             <span class='hs-comment'>-- ^ filepath to read from</span>
<a name="line-95"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>           <span class='hs-comment'>-- ^ 'Auto' to resume</span>
<a name="line-96"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-definition'>readAutoDef</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-98"></a>    <span class='hs-varid'>esa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>try</span> <span class='hs-layout'>(</span><span class='hs-varid'>readAuto</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>;</span>
<a name="line-99"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>esa</span> <span class='hs-keyword'>of</span>
<a name="line-100"></a>      <span class='hs-conid'>Right</span> <span class='hs-varid'>a'</span>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a'</span>
<a name="line-101"></a>      <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-102"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throw</span> <span class='hs-varid'>e</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="readAutoErr"></a><span class='hs-comment'>-- | Like 'readAuto', but will throw a runtime exception on a failure to</span>
<a name="line-105"></a><span class='hs-comment'>-- decode or an IO error.</span>
<a name="line-106"></a><span class='hs-definition'>readAutoErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>             <span class='hs-comment'>-- ^ filepath to read from</span>
<a name="line-107"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>           <span class='hs-comment'>-- ^ 'Auto' to resume</span>
<a name="line-108"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-109"></a><span class='hs-definition'>readAutoErr</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-110"></a>    <span class='hs-varid'>esa</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readAuto</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span>
<a name="line-111"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>esa</span> <span class='hs-keyword'>of</span>
<a name="line-112"></a>      <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"readAutoErr: Corrupted Auto binary -- "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>e</span>
<a name="line-113"></a>      <span class='hs-conid'>Right</span> <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a'</span>
<a name="line-114"></a>
<a name="line-115"></a><a name="writeAuto"></a><span class='hs-comment'>-- | Given a 'FilePath' and an 'Auto', serialize and freeze the state of</span>
<a name="line-116"></a><span class='hs-comment'>-- the 'Auto' as binary to that 'FilePath'.</span>
<a name="line-117"></a><span class='hs-definition'>writeAuto</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>       <span class='hs-comment'>-- ^ filepath to write to</span>
<a name="line-118"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>     <span class='hs-comment'>-- ^ 'Auto' to serialize</span>
<a name="line-119"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-120"></a><span class='hs-definition'>writeAuto</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>writeFile</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>(</span><span class='hs-varid'>encodeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="saving"></a><span class='hs-comment'>-- | "Transforms" the given 'Auto' into an 'Auto' that constantly saves its</span>
<a name="line-123"></a><span class='hs-comment'>-- state to the given 'FilePath' at every "step".  Requires an underlying</span>
<a name="line-124"></a><span class='hs-comment'>-- 'MonadIO'.</span>
<a name="line-125"></a><span class='hs-comment'>--</span>
<a name="line-126"></a><span class='hs-comment'>-- Note that (unless the 'Auto' depends on IO), the resulting 'Auto' is</span>
<a name="line-127"></a><span class='hs-comment'>-- meant to be operationally /identical/ in its inputs/outputs to the</span>
<a name="line-128"></a><span class='hs-comment'>-- original one.</span>
<a name="line-129"></a><span class='hs-comment'>--</span>
<a name="line-130"></a><span class='hs-definition'>saving</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-131"></a>       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span>          <span class='hs-comment'>-- ^ filepath to write to</span>
<a name="line-132"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>        <span class='hs-comment'>-- ^ 'Auto' to transform</span>
<a name="line-133"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-134"></a><span class='hs-definition'>saving</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interceptO</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-135"></a>                             <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeAuto</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a'</span>
<a name="line-136"></a>                             <span class='hs-varid'>return</span> <span class='hs-varid'>y</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="loading"></a><span class='hs-comment'>-- | "Transforms" the given 'Auto' into an 'Auto' that, when you /first/</span>
<a name="line-139"></a><span class='hs-comment'>-- try to run or step it, "loads" itself from disk at the given 'FilePath'.</span>
<a name="line-140"></a><span class='hs-comment'>--</span>
<a name="line-141"></a><span class='hs-comment'>-- Will throw a runtime exception on either an I/O error or a decoding</span>
<a name="line-142"></a><span class='hs-comment'>-- error.</span>
<a name="line-143"></a><span class='hs-comment'>--</span>
<a name="line-144"></a><span class='hs-comment'>-- Note that (unless the 'Auto' depends on IO), the resulting 'Auto' is</span>
<a name="line-145"></a><span class='hs-comment'>-- meant to be operationally /identical/ in its inputs/outputs to the</span>
<a name="line-146"></a><span class='hs-comment'>-- /fast-forwarded/ original 'Auto'.</span>
<a name="line-147"></a><span class='hs-comment'>--</span>
<a name="line-148"></a><span class='hs-definition'>loading</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-149"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span>         <span class='hs-comment'>-- ^ filepath to read from</span>
<a name="line-150"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>       <span class='hs-comment'>-- ^ 'Auto' to transform</span>
<a name="line-151"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-152"></a><span class='hs-definition'>loading</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loading</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-153"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-154"></a>                         <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-155"></a>                             <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>loaded</span> <span class='hs-varop'>.</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoErr</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a0</span>
<a name="line-156"></a>                             <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-157"></a>  <span class='hs-keyword'>where</span>
<a name="line-158"></a>    <span class='hs-varid'>loaded</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loading'</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-160"></a>                       <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-161"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-162"></a>                           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loaded</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-163"></a>
<a name="line-164"></a>
<a name="line-165"></a>
<a name="line-166"></a><a name="loading'"></a><span class='hs-comment'>-- | Like 'loading', except silently suppresses all I/O and decoding</span>
<a name="line-167"></a><span class='hs-comment'>-- errors; if there are errors, it returns back the given 'Auto' as-is.</span>
<a name="line-168"></a><span class='hs-comment'>--</span>
<a name="line-169"></a><span class='hs-comment'>-- Useful for when you aren't sure the save state is on disk or not yet,</span>
<a name="line-170"></a><span class='hs-comment'>-- and want to resume it only in the case that it is.</span>
<a name="line-171"></a><span class='hs-definition'>loading'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-172"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span>        <span class='hs-comment'>-- ^ filepath to read from</span>
<a name="line-173"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>      <span class='hs-comment'>-- ^ 'Auto' to transform (or return unchanged)</span>
<a name="line-174"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-175"></a><span class='hs-definition'>loading'</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loading'</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-176"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-177"></a>                         <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-178"></a>                             <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-179"></a>                               <span class='hs-varid'>ea'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoDef</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a0</span>
<a name="line-180"></a>                               <span class='hs-keyword'>case</span> <span class='hs-varid'>ea'</span> <span class='hs-keyword'>of</span>
<a name="line-181"></a>                                 <span class='hs-conid'>Right</span> <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>loaded</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-182"></a>                                 <span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a0</span>
<a name="line-183"></a>                             <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-184"></a>  <span class='hs-keyword'>where</span>
<a name="line-185"></a>    <span class='hs-varid'>loaded</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loading'</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-186"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-187"></a>                       <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-188"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-189"></a>                           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loaded</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="serializing"></a><span class='hs-comment'>-- | A combination of 'saving' and 'loading'.  When the 'Auto' is first</span>
<a name="line-192"></a><span class='hs-comment'>-- run, it loads the save state from the given 'FilePath' and fast forwards</span>
<a name="line-193"></a><span class='hs-comment'>-- it.  Then, subsequently, it updates the save state on disk on every</span>
<a name="line-194"></a><span class='hs-comment'>-- step.</span>
<a name="line-195"></a><span class='hs-definition'>serializing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-196"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span>     <span class='hs-comment'>-- ^ filepath to read from and write to</span>
<a name="line-197"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>   <span class='hs-comment'>-- ^ 'Auto' to transform</span>
<a name="line-198"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-199"></a><span class='hs-definition'>serializing</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loading</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>(</span><span class='hs-varid'>saving</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-200"></a>
<a name="line-201"></a><a name="serializing'"></a><span class='hs-comment'>-- | Like 'serializing', except suppresses all I/O and decoding errors.</span>
<a name="line-202"></a><span class='hs-comment'>--</span>
<a name="line-203"></a><span class='hs-comment'>-- Useful in the case that when the 'Auto' is first run and there is no</span>
<a name="line-204"></a><span class='hs-comment'>-- save state yet on disk (or the save state is corrupted), it'll "start</span>
<a name="line-205"></a><span class='hs-comment'>-- a new one"; if there is one, it'll load it automatically.  Then, on</span>
<a name="line-206"></a><span class='hs-comment'>-- every further step in both cases, it'll update the save state.</span>
<a name="line-207"></a><span class='hs-definition'>serializing'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-208"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>FilePath</span>        <span class='hs-comment'>-- ^ filepath to read from and write to</span>
<a name="line-209"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>      <span class='hs-comment'>-- ^ 'Auto' to transform</span>
<a name="line-210"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-211"></a><span class='hs-definition'>serializing'</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loading'</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>(</span><span class='hs-varid'>saving</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-212"></a>
<a name="line-213"></a><span class='hs-comment'>-- $onfrom</span>
<a name="line-214"></a><span class='hs-comment'>--</span>
<a name="line-215"></a><span class='hs-comment'>-- Note that these follow the naming conventions from</span>
<a name="line-216"></a><span class='hs-comment'>-- "Control.Auto.Switch": Something "from" a blip stream is a thing</span>
<a name="line-217"></a><span class='hs-comment'>-- triggered by the 'Auto' itself, and something "on" a blip stream is</span>
<a name="line-218"></a><span class='hs-comment'>-- a thing triggered externally, from another 'Auto'.</span>
<a name="line-219"></a>
<a name="line-220"></a><a name="saveFromB"></a><span class='hs-comment'>-- | Takes an 'Auto' that produces a blip stream with a 'FilePath' and</span>
<a name="line-221"></a><span class='hs-comment'>-- a value, and turns it into an 'Auto' that, outwardly, produces just the</span>
<a name="line-222"></a><span class='hs-comment'>-- value.</span>
<a name="line-223"></a><span class='hs-comment'>--</span>
<a name="line-224"></a><span class='hs-comment'>-- Whenever the output blip stream emits, it automatically serializes and</span>
<a name="line-225"></a><span class='hs-comment'>-- saves the state of the 'Auto' to the emitted 'FilePath'.</span>
<a name="line-226"></a><span class='hs-comment'>--</span>
<a name="line-227"></a><span class='hs-comment'>-- In practice, this allows any 'Auto' to basically control when it wants</span>
<a name="line-228"></a><span class='hs-comment'>-- to "save", by providing a blip stream.</span>
<a name="line-229"></a><span class='hs-comment'>--</span>
<a name="line-230"></a><span class='hs-comment'>-- The following is an alternative implementation of 'saving', except</span>
<a name="line-231"></a><span class='hs-comment'>-- saving every two steps instead of every step:</span>
<a name="line-232"></a><span class='hs-comment'>--</span>
<a name="line-233"></a><span class='hs-comment'>-- @</span>
<a name="line-234"></a><span class='hs-comment'>-- saving2 fp a = 'saveFromB' (a '&amp;&amp;&amp;' ('every' 2 . 'pure' fp))</span>
<a name="line-235"></a><span class='hs-comment'>-- @</span>
<a name="line-236"></a><span class='hs-comment'>--</span>
<a name="line-237"></a><span class='hs-comment'>-- Or, in proc notation:</span>
<a name="line-238"></a><span class='hs-comment'>--</span>
<a name="line-239"></a><span class='hs-comment'>-- &gt; saving2 fp a = saveFromB $ proc x -&gt; do</span>
<a name="line-240"></a><span class='hs-comment'>-- &gt;     y &lt;- a       -&lt; x</span>
<a name="line-241"></a><span class='hs-comment'>-- &gt;     b &lt;- every 2 -&lt; fp</span>
<a name="line-242"></a><span class='hs-comment'>-- &gt;     id -&lt; (y, b)</span>
<a name="line-243"></a><span class='hs-comment'>--</span>
<a name="line-244"></a><span class='hs-comment'>-- (Recall that @'every' n@ is the "Auto" that emits the received value</span>
<a name="line-245"></a><span class='hs-comment'>-- every @n@ steps)</span>
<a name="line-246"></a><span class='hs-comment'>--</span>
<a name="line-247"></a><span class='hs-comment'>-- In useful real-world cases, you can have the 'Auto' decide whether or</span>
<a name="line-248"></a><span class='hs-comment'>-- not to save itself based on its input.  Like, for example, when it</span>
<a name="line-249"></a><span class='hs-comment'>-- detects a certain user command, or when the user has reached a given</span>
<a name="line-250"></a><span class='hs-comment'>-- location.</span>
<a name="line-251"></a><span class='hs-comment'>--</span>
<a name="line-252"></a><span class='hs-comment'>-- The following takes a 'FilePath' and an 'Auto' (@a@), and turns it into</span>
<a name="line-253"></a><span class='hs-comment'>-- an 'Auto' that "saves" whenever @a@ crosses over from positive to</span>
<a name="line-254"></a><span class='hs-comment'>-- negative.</span>
<a name="line-255"></a><span class='hs-comment'>--</span>
<a name="line-256"></a><span class='hs-comment'>-- @</span>
<a name="line-257"></a><span class='hs-comment'>-- saveOnNegative fp a = saveFromB $ proc x -&gt; do</span>
<a name="line-258"></a><span class='hs-comment'>--     y       &lt;- a            -&lt; x</span>
<a name="line-259"></a><span class='hs-comment'>--     saveNow &lt;- 'became' (&lt; 0) -&lt; y</span>
<a name="line-260"></a><span class='hs-comment'>--     id       -&lt; (y, fp '&lt;$' saveNow)</span>
<a name="line-261"></a><span class='hs-comment'>-- @</span>
<a name="line-262"></a><span class='hs-comment'>--</span>
<a name="line-263"></a><span class='hs-comment'>-- Contrast to 'saveOnB', where the saves are triggered by outside input.</span>
<a name="line-264"></a><span class='hs-comment'>-- In this case, the saves are triggered by the 'Auto' to be saved itself.</span>
<a name="line-265"></a><span class='hs-comment'>--</span>
<a name="line-266"></a><span class='hs-definition'>saveFromB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-267"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ 'Auto' producing a value</span>
<a name="line-268"></a>                                            <span class='hs-comment'>--   @b@ and a blip stream</span>
<a name="line-269"></a>                                            <span class='hs-comment'>--   with a 'FilePath' to save</span>
<a name="line-270"></a>                                            <span class='hs-comment'>--   to</span>
<a name="line-271"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-272"></a><span class='hs-definition'>saveFromB</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>interceptO</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-273"></a>                             <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-274"></a>                               <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeAuto</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a'</span>
<a name="line-275"></a>                               <span class='hs-keyword'>_</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-276"></a>                             <span class='hs-varid'>return</span> <span class='hs-varid'>y</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="loadFromB"></a><span class='hs-comment'>-- | Takes an 'Auto' that outputs a @b@ and a blip stream of 'FilePath's</span>
<a name="line-279"></a><span class='hs-comment'>-- and returns an 'Auto' that ouputs only that @b@ stream...but every time</span>
<a name="line-280"></a><span class='hs-comment'>-- the blip stream emits, it "resets/loads" itself from that 'FilePath'.</span>
<a name="line-281"></a><span class='hs-comment'>--</span>
<a name="line-282"></a><span class='hs-comment'>-- The following is a re-implementation of 'loading'...except delayed by</span>
<a name="line-283"></a><span class='hs-comment'>-- one (the second step that is run is the first "resumed" step).</span>
<a name="line-284"></a><span class='hs-comment'>--</span>
<a name="line-285"></a><span class='hs-comment'>-- @</span>
<a name="line-286"></a><span class='hs-comment'>-- loading2 fp a = 'loadFromB' $ proc x -&gt; do</span>
<a name="line-287"></a><span class='hs-comment'>--     y       &lt;- a           -&lt; x</span>
<a name="line-288"></a><span class='hs-comment'>--     loadNow &lt;- 'immediately' -&lt; fp</span>
<a name="line-289"></a><span class='hs-comment'>--     'id'       -&lt; (y, loadNow)</span>
<a name="line-290"></a><span class='hs-comment'>-- @</span>
<a name="line-291"></a><span class='hs-comment'>--</span>
<a name="line-292"></a><span class='hs-comment'>-- (the blip stream emits only once, immediately, to re-load).</span>
<a name="line-293"></a><span class='hs-comment'>--</span>
<a name="line-294"></a><span class='hs-comment'>-- In the real world, you could have the 'Auto' decide to reset or resume</span>
<a name="line-295"></a><span class='hs-comment'>-- itself based on a user command:</span>
<a name="line-296"></a><span class='hs-comment'>--</span>
<a name="line-297"></a><span class='hs-comment'>-- @</span>
<a name="line-298"></a><span class='hs-comment'>-- loadFrom = loadFromB $ proc x -&gt; do</span>
<a name="line-299"></a><span class='hs-comment'>--     steps  &lt;- count -&lt; ()</span>
<a name="line-300"></a><span class='hs-comment'>--     toLoad &lt;- case words x of</span>
<a name="line-301"></a><span class='hs-comment'>--                   ("load":fp:_) -&gt; do</span>
<a name="line-302"></a><span class='hs-comment'>--                       immediately -&lt; fp</span>
<a name="line-303"></a><span class='hs-comment'>--                   _             -&gt; do</span>
<a name="line-304"></a><span class='hs-comment'>--                       never       -&lt; ()</span>
<a name="line-305"></a><span class='hs-comment'>--     id      -&lt; (steps, toLoad)</span>
<a name="line-306"></a><span class='hs-comment'>-- @</span>
<a name="line-307"></a><span class='hs-comment'>--</span>
<a name="line-308"></a><span class='hs-comment'>-- This will throw a runtime error on an IO exception or parsing error.</span>
<a name="line-309"></a><span class='hs-comment'>--</span>
<a name="line-310"></a><span class='hs-definition'>loadFromB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-311"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ 'Auto' with an output</span>
<a name="line-312"></a>                                            <span class='hs-comment'>--     and a blip stream to</span>
<a name="line-313"></a>                                            <span class='hs-comment'>--     trigger re-loading</span>
<a name="line-314"></a>                                            <span class='hs-comment'>--     itself from the given</span>
<a name="line-315"></a>                                            <span class='hs-comment'>--     filepath</span>
<a name="line-316"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-317"></a><span class='hs-definition'>loadFromB</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadFromB'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-318"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-319"></a>                      <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-320"></a>                          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-321"></a>                          <span class='hs-varid'>a''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-322"></a>                                   <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoErr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a'</span>
<a name="line-323"></a>                                   <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a'</span>
<a name="line-324"></a>                          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadFromB'</span> <span class='hs-varid'>a''</span><span class='hs-layout'>)</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="loadFromB'"></a><span class='hs-comment'>-- | Like 'loadFromB', except silently ignores errors.  When a load is</span>
<a name="line-327"></a><span class='hs-comment'>-- requested, but there is an IO or parse error, the loading is skipped.</span>
<a name="line-328"></a><span class='hs-definition'>loadFromB'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-329"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ 'Auto' with an output</span>
<a name="line-330"></a>                                            <span class='hs-comment'>--     and a blip stream to</span>
<a name="line-331"></a>                                            <span class='hs-comment'>--     trigger re-loading</span>
<a name="line-332"></a>                                            <span class='hs-comment'>--     itself from the given</span>
<a name="line-333"></a>                                            <span class='hs-comment'>--     filepath</span>
<a name="line-334"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-335"></a><span class='hs-definition'>loadFromB'</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadFromB'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-336"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-337"></a>                        <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-338"></a>                            <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>x</span>
<a name="line-339"></a>                            <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-340"></a>                                    <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-341"></a>                                      <span class='hs-varid'>ea3</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoDef</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a1</span>
<a name="line-342"></a>                                      <span class='hs-keyword'>case</span> <span class='hs-varid'>ea3</span> <span class='hs-keyword'>of</span>
<a name="line-343"></a>                                        <span class='hs-conid'>Right</span> <span class='hs-varid'>a3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a3</span>
<a name="line-344"></a>                                        <span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a1</span>
<a name="line-345"></a>                                    <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a1</span>
<a name="line-346"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadFromB'</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-347"></a>
<a name="line-348"></a><a name="saveOnB"></a><span class='hs-comment'>-- | Takes an 'Auto' and basically "wraps" it so that you can trigger saves</span>
<a name="line-349"></a><span class='hs-comment'>-- with a blip stream.</span>
<a name="line-350"></a><span class='hs-comment'>--</span>
<a name="line-351"></a><span class='hs-comment'>-- For example, we can take @'sumFrom' 0@:</span>
<a name="line-352"></a><span class='hs-comment'>--</span>
<a name="line-353"></a><span class='hs-comment'>-- @</span>
<a name="line-354"></a><span class='hs-comment'>-- 'saveOnB' ('sumFrom' 0) :: 'Auto' 'IO' ('Int', 'Blip' 'FilePath') 'Int'</span>
<a name="line-355"></a><span class='hs-comment'>-- @</span>
<a name="line-356"></a><span class='hs-comment'>--</span>
<a name="line-357"></a><span class='hs-comment'>-- It'll behave just like @'sumFrom' 0@ (with the input you pass in the</span>
<a name="line-358"></a><span class='hs-comment'>-- first field of the tuple)...and whenever the blip stream (the second</span>
<a name="line-359"></a><span class='hs-comment'>-- field of the input tuple) emits, it'll save the state of @'sumFrom' 0@</span>
<a name="line-360"></a><span class='hs-comment'>-- to disk at the given 'FilePath'.</span>
<a name="line-361"></a><span class='hs-comment'>--</span>
<a name="line-362"></a><span class='hs-comment'>-- Contrast to 'saveFromB', where the 'Auto' itself can trigger saves; in</span>
<a name="line-363"></a><span class='hs-comment'>-- this one, saves are triggered "externally".</span>
<a name="line-364"></a><span class='hs-comment'>--</span>
<a name="line-365"></a><span class='hs-comment'>-- Might be useful in similar situations as 'saveFromB', except if you want</span>
<a name="line-366"></a><span class='hs-comment'>-- to trigger the save externally.</span>
<a name="line-367"></a><span class='hs-comment'>--</span>
<a name="line-368"></a><span class='hs-definition'>saveOnB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-369"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>       <span class='hs-comment'>-- ^ 'Auto' to make saveable-by-trigger</span>
<a name="line-370"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-371"></a><span class='hs-definition'>saveOnB</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>saveOnB</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-372"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-373"></a>                    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-374"></a>                      <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-375"></a>                        <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeAuto</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a</span>
<a name="line-376"></a>                        <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-377"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-378"></a>                      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>saveOnB</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-379"></a>
<a name="line-380"></a><a name="loadOnB"></a><span class='hs-comment'>-- | Takes an 'Auto' and basically "wraps" it so that you can trigger</span>
<a name="line-381"></a><span class='hs-comment'>-- loads/resumes from a file with a blip stream.</span>
<a name="line-382"></a><span class='hs-comment'>--</span>
<a name="line-383"></a><span class='hs-comment'>-- For example, we can take @'sumFrom' 0@:</span>
<a name="line-384"></a><span class='hs-comment'>--</span>
<a name="line-385"></a><span class='hs-comment'>-- @</span>
<a name="line-386"></a><span class='hs-comment'>-- 'loadOnB' ('sumFrom' 0) :: 'Auto' 'IO' ('Int', 'Blip' 'FilePath') 'Int'</span>
<a name="line-387"></a><span class='hs-comment'>-- @</span>
<a name="line-388"></a><span class='hs-comment'>--</span>
<a name="line-389"></a><span class='hs-comment'>-- It'll behave just like @'sumFrom' 0@ (with the input you pass in the</span>
<a name="line-390"></a><span class='hs-comment'>-- first field of the tiple)...and whenever the blip stream (the second</span>
<a name="line-391"></a><span class='hs-comment'>-- field of the input tuple) emits, it'll "reset" and "reload" the</span>
<a name="line-392"></a><span class='hs-comment'>-- @'sumFrom' 0@ from the 'FilePath' on disk.</span>
<a name="line-393"></a><span class='hs-comment'>--</span>
<a name="line-394"></a><span class='hs-comment'>-- Will throw a runtime exception if there is an IO error or a parse error.</span>
<a name="line-395"></a><span class='hs-comment'>--</span>
<a name="line-396"></a><span class='hs-comment'>-- Contrast to 'loadFromB', where the 'Auto' itself can trigger</span>
<a name="line-397"></a><span class='hs-comment'>-- reloads/resets; in this one, the loads are triggered "externally".</span>
<a name="line-398"></a><span class='hs-comment'>--</span>
<a name="line-399"></a><span class='hs-comment'>-- Might be useful in similar situations as 'loadFromB', except if you want</span>
<a name="line-400"></a><span class='hs-comment'>-- to trigger the loading externally.</span>
<a name="line-401"></a><span class='hs-comment'>--</span>
<a name="line-402"></a><span class='hs-definition'>loadOnB</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-403"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>       <span class='hs-comment'>-- ^ 'Auto' to make reloadable-by-trigger</span>
<a name="line-404"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-405"></a><span class='hs-definition'>loadOnB</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadOnB'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-406"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-407"></a>                    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-408"></a>                        <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-409"></a>                                <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoErr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a</span>
<a name="line-410"></a>                                <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-411"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>x</span>
<a name="line-412"></a>                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadOnB'</span> <span class='hs-varid'>a''</span><span class='hs-layout'>)</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="loadOnB'"></a><span class='hs-comment'>-- | Like 'loadOnB', except silently ignores errors.  When a load is</span>
<a name="line-415"></a><span class='hs-comment'>-- requested, but there is an IO or parse error, the loading is skipped.</span>
<a name="line-416"></a><span class='hs-definition'>loadOnB'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-417"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>      <span class='hs-comment'>-- ^ 'Auto' to make reloadable-by-trigger</span>
<a name="line-418"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-419"></a><span class='hs-definition'>loadOnB'</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadOnB'</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-420"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-421"></a>                      <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-422"></a>                          <span class='hs-varid'>a1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-423"></a>                                  <span class='hs-conid'>Blip</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-424"></a>                                    <span class='hs-varid'>ea2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readAutoDef</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a0</span>
<a name="line-425"></a>                                    <span class='hs-keyword'>case</span> <span class='hs-varid'>ea2</span> <span class='hs-keyword'>of</span>
<a name="line-426"></a>                                      <span class='hs-conid'>Right</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a2</span>
<a name="line-427"></a>                                      <span class='hs-conid'>Left</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a0</span>
<a name="line-428"></a>                                  <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a0</span>
<a name="line-429"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>x</span>
<a name="line-430"></a>                          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>loadOnB'</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-431"></a>
</pre></body>
</html>
