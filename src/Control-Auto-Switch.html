<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Control/Auto/Switch.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>-- |</span>
<a name="line-2"></a><span class='hs-comment'>-- Module      : Control.Auto.Switch</span>
<a name="line-3"></a><span class='hs-comment'>-- Description : Combinators for dynamically switching between and</span>
<a name="line-4"></a><span class='hs-comment'>--               sequencing 'Auto's.</span>
<a name="line-5"></a><span class='hs-comment'>-- Copyright   : (c) Justin Le 2015</span>
<a name="line-6"></a><span class='hs-comment'>-- License     : MIT</span>
<a name="line-7"></a><span class='hs-comment'>-- Maintainer  : justin@jle.im</span>
<a name="line-8"></a><span class='hs-comment'>-- Stability   : unstable</span>
<a name="line-9"></a><span class='hs-comment'>-- Portability : portable</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>-- A collection of versatile switching mechanisms.  Switching is really</span>
<a name="line-13"></a><span class='hs-comment'>-- a core mechanic at the heart of how to structure a lot of program</span>
<a name="line-14"></a><span class='hs-comment'>-- logics.  Switching from one "mode" to another, from dead to alive, from</span>
<a name="line-15"></a><span class='hs-comment'>-- room to room, menu to menu...switching between 'Auto's is a core part</span>
<a name="line-16"></a><span class='hs-comment'>-- about how many programs are built.</span>
<a name="line-17"></a><span class='hs-comment'>--</span>
<a name="line-18"></a><span class='hs-comment'>-- All of the switches here take advantage of either blip semantics (from</span>
<a name="line-19"></a><span class='hs-comment'>-- "Control.Auto.Blip") or /Interval/ semantics (from</span>
<a name="line-20"></a><span class='hs-comment'>-- "Control.Auto.Interval")...so this is where maintaining semantically</span>
<a name="line-21"></a><span class='hs-comment'>-- meaningful blip streams and intervals pays off!</span>
<a name="line-22"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><span class='hs-comment'>-- Each switch here has various examples, and you'll find many of these in</span>
<a name="line-24"></a><span class='hs-comment'>-- use in the &lt;https://github.com/mstksg/auto-examples example projects&gt;.</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-comment'>-- Note the naming convention going on here (also used in</span>
<a name="line-27"></a><span class='hs-comment'>-- "Control.Auto.Serialize"):  A switch "from" a blip stream is triggered</span>
<a name="line-28"></a><span class='hs-comment'>-- "internally" by the 'Auto' being switched itself; a switch "on" a blip</span>
<a name="line-29"></a><span class='hs-comment'>-- stream is triggered "externally" by an 'Auto' that is /not/ swiched.</span>
<a name="line-30"></a><span class='hs-comment'>--</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Switch</span> <span class='hs-layout'>(</span>
<a name="line-33"></a>  <span class='hs-comment'>-- * Sequential switching</span>
<a name="line-34"></a>    <span class='hs-layout'>(</span><span class='hs-varop'>--&gt;</span><span class='hs-layout'>)</span>
<a name="line-35"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>-?&gt;</span><span class='hs-layout'>)</span>
<a name="line-36"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchIn</span>
<a name="line-37"></a>  <span class='hs-comment'>-- * Arbitrary switching</span>
<a name="line-38"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchFrom_</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchOn_</span>
<a name="line-40"></a>  <span class='hs-comment'>-- * Function-based switches</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchOnF</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchOnF_</span>
<a name="line-43"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchFromF</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchFromF_</span>
<a name="line-45"></a>  <span class='hs-comment'>-- * Resetting</span>
<a name="line-46"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>resetOn</span>
<a name="line-47"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>resetFrom</span>
<a name="line-48"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Blip</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Blip</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Core</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Auto</span><span class='hs-varop'>.</span><span class='hs-conid'>Interval</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Category</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Serialize</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span>             <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>.</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>1</span> <span class='hs-varop'>--&gt;</span>
<a name="line-62"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>1</span> <span class='hs-varop'>-?&gt;</span>
<a name="line-63"></a>
<a name="line-64"></a><a name="--%3e"></a><span class='hs-comment'>-- | "This, then that".  Behave like the first 'Interval' (and run its</span>
<a name="line-65"></a><span class='hs-comment'>-- effects) as long as it is "on" (outputting 'Just').  As soon as it turns</span>
<a name="line-66"></a><span class='hs-comment'>-- off (is 'Nothing'), it'll "switch over" and begin behaving like the</span>
<a name="line-67"></a><span class='hs-comment'>-- second 'Auto' forever, running the effects of the second 'Auto', too.</span>
<a name="line-68"></a><span class='hs-comment'>-- Works well if the 'Auto's follow interval semantics from</span>
<a name="line-69"></a><span class='hs-comment'>-- "Control.Auto.Interval".</span>
<a name="line-70"></a><span class='hs-comment'>--</span>
<a name="line-71"></a><span class='hs-comment'>-- &gt;&gt;&gt; let a1 = whenI (&lt;= 4) --&gt; pure 0</span>
<a name="line-72"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a1 [1..10]</span>
<a name="line-73"></a><span class='hs-comment'>-- [1, 2, 3, 4, 0, 0, 0, 0, 0, 0]</span>
<a name="line-74"></a><span class='hs-comment'>--</span>
<a name="line-75"></a><span class='hs-comment'>-- ('whenI' only lets items satisfying the predicate pass through as "on",</span>
<a name="line-76"></a><span class='hs-comment'>-- and is "off" otherwise; 'pure' is the 'Auto' that always produces the</span>
<a name="line-77"></a><span class='hs-comment'>-- same output)</span>
<a name="line-78"></a><span class='hs-comment'>--</span>
<a name="line-79"></a><span class='hs-comment'>-- Association works in a way that you can "chain" '--&gt;'s, as long as you</span>
<a name="line-80"></a><span class='hs-comment'>-- have an appropriate 'Auto' (and not 'Interval') at the end:</span>
<a name="line-81"></a><span class='hs-comment'>--</span>
<a name="line-82"></a><span class='hs-comment'>-- &gt;&gt;&gt; let a2 = onFor 3 . sumFrom 0</span>
<a name="line-83"></a><span class='hs-comment'>--          --&gt; onFor 3 . sumFrom 100</span>
<a name="line-84"></a><span class='hs-comment'>--          --&gt; pure 0</span>
<a name="line-85"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a2 [1..10]</span>
<a name="line-86"></a><span class='hs-comment'>-- [1,3,6,104,109,115,0,0,0,0]</span>
<a name="line-87"></a><span class='hs-comment'>--</span>
<a name="line-88"></a><span class='hs-comment'>-- @a --&gt; b --&gt; c@ associates as @a --&gt; (b --&gt; c)@</span>
<a name="line-89"></a><span class='hs-comment'>--</span>
<a name="line-90"></a><span class='hs-comment'>-- This is pretty invaluable for having 'Auto's "step" through a series of</span>
<a name="line-91"></a><span class='hs-comment'>-- different 'Auto's, progressing their state from one stage to the next.</span>
<a name="line-92"></a><span class='hs-comment'>-- 'Auto's can control when they want to be "moved on" from by turning</span>
<a name="line-93"></a><span class='hs-comment'>-- "off" (outputting 'Nothing').</span>
<a name="line-94"></a><span class='hs-comment'>--</span>
<a name="line-95"></a><span class='hs-comment'>-- Note that recursive bindings work just fine, so:</span>
<a name="line-96"></a><span class='hs-comment'>--</span>
<a name="line-97"></a><span class='hs-comment'>-- &gt;&gt;&gt; let a3 = onFor 2 . pure "hello"</span>
<a name="line-98"></a><span class='hs-comment'>--          --&gt; onFor 2 . pure "world"</span>
<a name="line-99"></a><span class='hs-comment'>--          --&gt; a3</span>
<a name="line-100"></a><span class='hs-comment'>-- &gt;&gt;&gt; let (res3, _) = stepAutoN' 8 a3 ()</span>
<a name="line-101"></a><span class='hs-comment'>-- &gt;&gt;&gt; res3</span>
<a name="line-102"></a><span class='hs-comment'>-- ["hello", "hello", "world", "world", "hello", "hello", "world", "world"]</span>
<a name="line-103"></a><span class='hs-comment'>--</span>
<a name="line-104"></a><span class='hs-comment'>-- the above represents an infinite loop between outputting "hello" and</span>
<a name="line-105"></a><span class='hs-comment'>-- outputting "world".</span>
<a name="line-106"></a><span class='hs-comment'>--</span>
<a name="line-107"></a><span class='hs-comment'>-- For serialization, an extra byte cost is incurred per invocation of</span>
<a name="line-108"></a><span class='hs-comment'>-- '--&gt;'.  For cyclic switches like @a3@, every time the cycle "completes",</span>
<a name="line-109"></a><span class='hs-comment'>-- it adds another layer of '--&gt;' byte costs.  For example, initially,</span>
<a name="line-110"></a><span class='hs-comment'>-- saving @a3@ incurs a cost for the two '--&gt;'s.  After @a3@ loops once,</span>
<a name="line-111"></a><span class='hs-comment'>-- it incurs a cost for another two '--&gt;'s, so it costs four '--&gt;'s.  After</span>
<a name="line-112"></a><span class='hs-comment'>-- @a3@ loops another time, it is like a cost of six '--&gt;'s.  So be aware</span>
<a name="line-113"></a><span class='hs-comment'>-- that for cyclic bindings like @a3@, space for serialization grows at</span>
<a name="line-114"></a><span class='hs-comment'>-- O(n).</span>
<a name="line-115"></a><span class='hs-comment'>--</span>
<a name="line-116"></a><span class='hs-comment'>-- By the way, it might be worth contrasting this with '&lt;|!&gt;' and '&lt;|?&gt;'</span>
<a name="line-117"></a><span class='hs-comment'>-- from "Control.Auto.Interval", which have the same type signatures.</span>
<a name="line-118"></a><span class='hs-comment'>-- Those alternative-y operators always /feed the input to both sides/,</span>
<a name="line-119"></a><span class='hs-comment'>-- /run both sides/, and output the first 'Just'.  With '&lt;|!&gt;', you can</span>
<a name="line-120"></a><span class='hs-comment'>-- "switch back and forth" to the first 'Auto' as soon as the first 'Auto'</span>
<a name="line-121"></a><span class='hs-comment'>-- is "on" ('Just') again.</span>
<a name="line-122"></a><span class='hs-comment'>--</span>
<a name="line-123"></a><span class='hs-comment'>-- '--&gt;', in contrast, runs /only/ the first 'Auto' until it is</span>
<a name="line-124"></a><span class='hs-comment'>-- off ('Nothing')...then runs /only/ the second 'Auto'.  This transition is</span>
<a name="line-125"></a><span class='hs-comment'>-- one-way, as well.</span>
<a name="line-126"></a><span class='hs-layout'>(</span><span class='hs-varop'>--&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-127"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Interval</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>     <span class='hs-comment'>-- ^ initial behavior</span>
<a name="line-128"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>         <span class='hs-comment'>-- ^ final behavior, when the initial</span>
<a name="line-129"></a>                            <span class='hs-comment'>--   behavior turns off.</span>
<a name="line-130"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-131"></a><a name="a1"></a><span class='hs-definition'>a1</span> <span class='hs-varop'>--&gt;</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>fromJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>a1</span> <span class='hs-varop'>-?&gt;</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a><a name="-?%3e"></a><span class='hs-comment'>-- | A variation of '--&gt;', where the right hand side can also be an</span>
<a name="line-134"></a><span class='hs-comment'>-- 'Interval' / 'Maybe'.  The entire result is, then, a 'Maybe'.  Probably less</span>
<a name="line-135"></a><span class='hs-comment'>-- useful than '--&gt;' in most situations.</span>
<a name="line-136"></a><span class='hs-layout'>(</span><span class='hs-varop'>-?&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-137"></a>      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Interval</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>   <span class='hs-comment'>-- ^ initial behavior</span>
<a name="line-138"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Interval</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>   <span class='hs-comment'>-- ^ final behavior, when the initial</span>
<a name="line-139"></a>                          <span class='hs-comment'>--   behavior turns off.</span>
<a name="line-140"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Interval</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-141"></a><span class='hs-definition'>a1</span> <span class='hs-varop'>-?&gt;</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-varid'>l</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span>
<a name="line-142"></a>  <span class='hs-keyword'>where</span>
<a name="line-143"></a>    <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-144"></a>      <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-145"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>flag</span>
<a name="line-146"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>switched</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-147"></a>        <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varop'>-?&gt;</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a1</span>
<a name="line-148"></a>    <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put</span> <span class='hs-conid'>False</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a1</span>
<a name="line-149"></a>    <span class='hs-varid'>t</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-150"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>y1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>x</span>
<a name="line-151"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>y1</span> <span class='hs-keyword'>of</span>
<a name="line-152"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span>
<a name="line-153"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y1</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1'</span> <span class='hs-varop'>-?&gt;</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-154"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-155"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a2'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a2</span> <span class='hs-varid'>x</span>
<a name="line-156"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switched</span> <span class='hs-varid'>a2'</span><span class='hs-layout'>)</span>
<a name="line-157"></a>    <span class='hs-varid'>switched</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-varid'>l</span>
<a name="line-158"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>put</span> <span class='hs-conid'>True</span>  <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-159"></a>                       <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-160"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-161"></a>                           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switched</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-comment'>-- TODO: Add tests for the serialization here.</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="switchIn"></a><span class='hs-comment'>-- | @'switchIn' n a1 a2@ will behave like @a1@ for @n@ steps of output,</span>
<a name="line-165"></a><span class='hs-comment'>-- and then behave like @a2@ forever after.</span>
<a name="line-166"></a><span class='hs-comment'>--</span>
<a name="line-167"></a><span class='hs-comment'>-- More or less a more efficient/direct implementation of the common idiom:</span>
<a name="line-168"></a><span class='hs-comment'>--</span>
<a name="line-169"></a><span class='hs-comment'>-- @</span>
<a name="line-170"></a><span class='hs-comment'>-- onFor n a1 --&gt; a2</span>
<a name="line-171"></a><span class='hs-comment'>-- @</span>
<a name="line-172"></a><span class='hs-comment'>--</span>
<a name="line-173"></a><span class='hs-comment'>--</span>
<a name="line-174"></a><span class='hs-definition'>switchIn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-175"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span>           <span class='hs-comment'>-- ^ number of outputs before switching</span>
<a name="line-176"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>    <span class='hs-comment'>-- ^ initial behavior</span>
<a name="line-177"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>    <span class='hs-comment'>-- ^ switched behavior</span>
<a name="line-178"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-179"></a><span class='hs-definition'>switchIn</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-varid'>l</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span>
<a name="line-180"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switched</span> <span class='hs-varid'>a2</span>
<a name="line-181"></a>  <span class='hs-keyword'>where</span>
<a name="line-182"></a>    <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-183"></a>      <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-184"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>flag</span>
<a name="line-185"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>switched</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-186"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>switchIn</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>get</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>a2</span>
<a name="line-187"></a>    <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put</span> <span class='hs-conid'>False</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>put</span> <span class='hs-varid'>n</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a1</span>
<a name="line-188"></a>    <span class='hs-varid'>t</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-189"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>x</span>
<a name="line-190"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchIn</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a1'</span> <span class='hs-varid'>a2</span><span class='hs-layout'>)</span>
<a name="line-191"></a>    <span class='hs-varid'>switched</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-varid'>l</span>
<a name="line-192"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>put</span> <span class='hs-conid'>True</span> <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-193"></a>                       <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-194"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-195"></a>                           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switched</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-196"></a>
<a name="line-197"></a>
<a name="line-198"></a><a name="switchFrom_"></a><span class='hs-comment'>-- | Takes an 'Auto' who has both a normal output stream and a blip stream</span>
<a name="line-199"></a><span class='hs-comment'>-- output stream, where the blip stream emits new 'Auto's.</span>
<a name="line-200"></a><span class='hs-comment'>--</span>
<a name="line-201"></a><span class='hs-comment'>-- You can imagine 'switchFrom_' as a box containing a single 'Auto' like</span>
<a name="line-202"></a><span class='hs-comment'>-- the one just described.  It feeds its input into the contained 'Auto',</span>
<a name="line-203"></a><span class='hs-comment'>-- and its output stream is the "normal value" output stream of the</span>
<a name="line-204"></a><span class='hs-comment'>-- contained 'Auto'.</span>
<a name="line-205"></a><span class='hs-comment'>--</span>
<a name="line-206"></a><span class='hs-comment'>-- However, as soon as the blip stream of the contained 'Auto' emits a new</span>
<a name="line-207"></a><span class='hs-comment'>-- 'Auto', it /replaces/ the contained 'Auto' with the /new/ one (just after</span>
<a name="line-208"></a><span class='hs-comment'>-- emitting the "normal value"), and the whole thing starts all over again.</span>
<a name="line-209"></a><span class='hs-comment'>--</span>
<a name="line-210"></a><span class='hs-comment'>-- @'switchFrom_' a0@ will "start" with @a0@ already in the box.</span>
<a name="line-211"></a><span class='hs-comment'>--</span>
<a name="line-212"></a><span class='hs-comment'>-- This is mostly useful to allow 'Auto's to "replace themselves" or</span>
<a name="line-213"></a><span class='hs-comment'>-- control their own destiny, or the behavior of their successors.</span>
<a name="line-214"></a><span class='hs-comment'>--</span>
<a name="line-215"></a><span class='hs-comment'>-- In the following example, @a1@ is an 'Auto' that behaves like</span>
<a name="line-216"></a><span class='hs-comment'>-- a cumulative sum but also outputs a blip stream that will emit an 'Auto'</span>
<a name="line-217"></a><span class='hs-comment'>-- containing @'pure' 100@ (the 'Auto' that always emits 100) after three</span>
<a name="line-218"></a><span class='hs-comment'>-- steps.</span>
<a name="line-219"></a><span class='hs-comment'>--</span>
<a name="line-220"></a><span class='hs-comment'>-- @</span>
<a name="line-221"></a><span class='hs-comment'>-- a1 :: Auto' Int (Int, Blip (Auto' Int Int))</span>
<a name="line-222"></a><span class='hs-comment'>-- a1 = proc x -&gt; do</span>
<a name="line-223"></a><span class='hs-comment'>--     sums       &lt;- sumFrom 0 -&lt; x</span>
<a name="line-224"></a><span class='hs-comment'>--     switchBlip &lt;- inB 4     -&lt; pure 100</span>
<a name="line-225"></a><span class='hs-comment'>--     id -&lt; (sums, switchBlip)</span>
<a name="line-226"></a><span class='hs-comment'>--</span>
<a name="line-227"></a><span class='hs-comment'>-- -- alternatively</span>
<a name="line-228"></a><span class='hs-comment'>-- a1' = sumFrom 0 &amp;&amp;&amp; (tagBlips (pure 100) . inB 4)</span>
<a name="line-229"></a><span class='hs-comment'>-- @</span>
<a name="line-230"></a><span class='hs-comment'>--</span>
<a name="line-231"></a><span class='hs-comment'>-- So, @'switchFrom_' a1@ will be the output of 'count' for three steps,</span>
<a name="line-232"></a><span class='hs-comment'>-- and then switch to @'pure' 100@ afterwards (when the blip stream</span>
<a name="line-233"></a><span class='hs-comment'>-- emits):</span>
<a name="line-234"></a><span class='hs-comment'>--</span>
<a name="line-235"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' (switchFrom_ a1) [1..10]</span>
<a name="line-236"></a><span class='hs-comment'>-- [1,3,6,10,100,100,100,100,100,100]</span>
<a name="line-237"></a><span class='hs-comment'>--</span>
<a name="line-238"></a><span class='hs-comment'>-- This is fun to use with recursion, so you can get looping switches:</span>
<a name="line-239"></a><span class='hs-comment'>--</span>
<a name="line-240"></a><span class='hs-comment'>-- @</span>
<a name="line-241"></a><span class='hs-comment'>-- a2 :: Auto' Int (Int, Blip (Auto' Int Int))</span>
<a name="line-242"></a><span class='hs-comment'>-- a2 = proc x -&gt; do</span>
<a name="line-243"></a><span class='hs-comment'>--     sums       &lt;- sumFrom 0 -&lt; x</span>
<a name="line-244"></a><span class='hs-comment'>--     switchBlip &lt;- inB 3     -&lt; switchFrom_ a2</span>
<a name="line-245"></a><span class='hs-comment'>--     id -&lt; (c, switchBlip)</span>
<a name="line-246"></a><span class='hs-comment'>--</span>
<a name="line-247"></a><span class='hs-comment'>-- -- alternatively</span>
<a name="line-248"></a><span class='hs-comment'>-- a2' = sumFrom 0 &amp;&amp;&amp; (tagBlips (switchFrom_ a2') . inB 3)</span>
<a name="line-249"></a><span class='hs-comment'>-- @</span>
<a name="line-250"></a><span class='hs-comment'>--</span>
<a name="line-251"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' (switchFrom_ a2) [101..112]</span>
<a name="line-252"></a><span class='hs-comment'>-- [ 101, 203, 306 -- first 'sumFrom', on first three items [101, 102, 103]</span>
<a name="line-253"></a><span class='hs-comment'>-- , 104, 209, 315 -- second 'sumFrom', on second three items [104, 105, 106]</span>
<a name="line-254"></a><span class='hs-comment'>-- , 107, 215, 324 -- third 'sumFrom', on third three items [107, 108, 109]</span>
<a name="line-255"></a><span class='hs-comment'>-- , 110, 221, 333 -- final 'sumFrom', on fourth three items [110, 111, 112]</span>
<a name="line-256"></a><span class='hs-comment'>-- ]</span>
<a name="line-257"></a><span class='hs-comment'>--</span>
<a name="line-258"></a><span class='hs-comment'>-- Note that this combinator is inherently unserializable, so you are going</span>
<a name="line-259"></a><span class='hs-comment'>-- to lose all serialization capabilities if you use this.  So sad, I know!</span>
<a name="line-260"></a><span class='hs-comment'>-- :(  This fact is reflected in the underscore suffix, as per convention.</span>
<a name="line-261"></a><span class='hs-comment'>--</span>
<a name="line-262"></a><span class='hs-comment'>-- If you want to use switching /and/ have serialization, you can use the</span>
<a name="line-263"></a><span class='hs-comment'>-- perfectly serialization-safe alternative, 'switchFromF', which slightly</span>
<a name="line-264"></a><span class='hs-comment'>-- less powerful in ways that are unlikely to be missed in practical usage.</span>
<a name="line-265"></a><span class='hs-comment'>-- That is, almost all non-contrived real life usages of 'switchFrom_' can</span>
<a name="line-266"></a><span class='hs-comment'>-- be recovered using 'switchFromF'.</span>
<a name="line-267"></a><span class='hs-comment'>--</span>
<a name="line-268"></a><span class='hs-definition'>switchFrom_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-269"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ 'Auto' outputting a</span>
<a name="line-270"></a>                                                <span class='hs-comment'>--   normal output (@b@)</span>
<a name="line-271"></a>                                                <span class='hs-comment'>--   and a blip stream</span>
<a name="line-272"></a>                                                <span class='hs-comment'>--   containing the 'Auto'</span>
<a name="line-273"></a>                                                <span class='hs-comment'>--   to replace itself</span>
<a name="line-274"></a>                                                <span class='hs-comment'>--   with.</span>
<a name="line-275"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-276"></a><span class='hs-definition'>switchFrom_</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-277"></a>                              <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>ea1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>x</span>
<a name="line-278"></a>                              <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ea1</span> <span class='hs-keyword'>of</span>
<a name="line-279"></a>                                <span class='hs-conid'>Blip</span> <span class='hs-varid'>a1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>
<a name="line-280"></a>                                <span class='hs-conid'>NoBlip</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchFrom_</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="switchOn_"></a><span class='hs-comment'>-- | You can think of this as a little box containing a single 'Auto'</span>
<a name="line-283"></a><span class='hs-comment'>-- inside.  Takes two input streams: an input stream of normal values, and</span>
<a name="line-284"></a><span class='hs-comment'>-- a blip stream containing 'Auto's.  It feeds the input stream into the</span>
<a name="line-285"></a><span class='hs-comment'>-- contained 'Auto'...but every time the input blip stream emits with a new</span>
<a name="line-286"></a><span class='hs-comment'>-- 'Auto', /replaces/ the contained 'Auto' with the emitted one.  Then</span>
<a name="line-287"></a><span class='hs-comment'>-- starts the cycle all over, immediately giving the new 'Auto' the</span>
<a name="line-288"></a><span class='hs-comment'>-- received input.</span>
<a name="line-289"></a><span class='hs-comment'>--</span>
<a name="line-290"></a><span class='hs-comment'>-- Useful for being able to externally "swap out" 'Auto's for a given</span>
<a name="line-291"></a><span class='hs-comment'>-- situation by just emitting a new 'Auto' in the blip stream.</span>
<a name="line-292"></a><span class='hs-comment'>--</span>
<a name="line-293"></a><span class='hs-comment'>-- For example, here we push several 'Auto's one after the other into the</span>
<a name="line-294"></a><span class='hs-comment'>-- box: @'sumFrom' 0@, @'productFrom' 1@, and 'count'. @'eachAt_' 4@ emits</span>
<a name="line-295"></a><span class='hs-comment'>-- each 'Auto' in the given list every four steps, starting on the fourth.</span>
<a name="line-296"></a><span class='hs-comment'>--</span>
<a name="line-297"></a><span class='hs-comment'>-- @</span>
<a name="line-298"></a><span class='hs-comment'>-- newAutos :: Auto' Int (Blip (Auto' Int Int))</span>
<a name="line-299"></a><span class='hs-comment'>-- newAutos = eachAt_ 4 [sumFrom 0, productFrom 1, count]</span>
<a name="line-300"></a><span class='hs-comment'>--</span>
<a name="line-301"></a><span class='hs-comment'>-- a :: Auto' Int Int</span>
<a name="line-302"></a><span class='hs-comment'>-- a = proc i -&gt; do</span>
<a name="line-303"></a><span class='hs-comment'>--     blipAutos &lt;- newAutos -&lt; ()</span>
<a name="line-304"></a><span class='hs-comment'>--     switchOn_ (pure 0)    -&lt; (i, blipAutos)</span>
<a name="line-305"></a><span class='hs-comment'>--</span>
<a name="line-306"></a><span class='hs-comment'>-- -- alternatively</span>
<a name="line-307"></a><span class='hs-comment'>-- a' = switchOn_ (pure 0) . (id &amp;&amp;&amp; newAutos)</span>
<a name="line-308"></a><span class='hs-comment'>-- @</span>
<a name="line-309"></a><span class='hs-comment'>--</span>
<a name="line-310"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a [1..12]</span>
<a name="line-311"></a><span class='hs-comment'>-- [ 1,  3,   6           -- output from sumFrom 0</span>
<a name="line-312"></a><span class='hs-comment'>-- , 4, 20, 120           -- output from productFrom 1</span>
<a name="line-313"></a><span class='hs-comment'>-- , 0,  1,   2, 3, 4, 5] -- output from count</span>
<a name="line-314"></a><span class='hs-comment'>--</span>
<a name="line-315"></a><span class='hs-comment'>-- Like 'switchFrom_', this combinator is inherently unserializable.  So if</span>
<a name="line-316"></a><span class='hs-comment'>-- you use it, you give up serialization for your 'Auto's.  This is</span>
<a name="line-317"></a><span class='hs-comment'>-- reflected in the underscore suffix.</span>
<a name="line-318"></a><span class='hs-comment'>--</span>
<a name="line-319"></a><span class='hs-comment'>-- If you wish to have the same switching devices but keep serialization,</span>
<a name="line-320"></a><span class='hs-comment'>-- you can use 'switchOnF', which is slightly less powerful, but should be</span>
<a name="line-321"></a><span class='hs-comment'>-- sufficient for all practical use cases.</span>
<a name="line-322"></a><span class='hs-comment'>--</span>
<a name="line-323"></a><span class='hs-definition'>switchOn_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-324"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>     <span class='hs-comment'>-- ^ initial 'Auto'</span>
<a name="line-325"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-layout'>(</span><span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-326"></a><span class='hs-definition'>switchOn_</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>ea1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-327"></a>                            <span class='hs-keyword'>let</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ea1</span> <span class='hs-keyword'>of</span>
<a name="line-328"></a>                                      <span class='hs-conid'>NoBlip</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a0</span>
<a name="line-329"></a>                                      <span class='hs-conid'>Blip</span> <span class='hs-varid'>a1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a1</span>
<a name="line-330"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-331"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchOn_</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span>
<a name="line-332"></a>
<a name="line-333"></a><a name="switchFromF"></a><span class='hs-comment'>-- | Essentially identical to 'switchFrom_', except insead of the 'Auto'</span>
<a name="line-334"></a><span class='hs-comment'>-- outputting a blip stream of new 'Auto's to replace itself with, it emits</span>
<a name="line-335"></a><span class='hs-comment'>-- a blip stream of @c@ --- and 'switchFromF' uses the @c@ to create the</span>
<a name="line-336"></a><span class='hs-comment'>-- new 'Auto'.</span>
<a name="line-337"></a><span class='hs-comment'>--</span>
<a name="line-338"></a><span class='hs-comment'>-- Here is the equivalent of the two examples from 'switchFrom_',</span>
<a name="line-339"></a><span class='hs-comment'>-- implemented with 'switchFromF'; see the documentation for 'switchFrom_'</span>
<a name="line-340"></a><span class='hs-comment'>-- for a description of what they are to do.</span>
<a name="line-341"></a><span class='hs-comment'>--</span>
<a name="line-342"></a><span class='hs-comment'>-- @</span>
<a name="line-343"></a><span class='hs-comment'>-- a1 :: Auto' Int (Int, Blip Int)</span>
<a name="line-344"></a><span class='hs-comment'>-- a1 = proc x -&gt; do</span>
<a name="line-345"></a><span class='hs-comment'>--     sums       &lt;- sumFrom 0 -&lt; x</span>
<a name="line-346"></a><span class='hs-comment'>--     switchBlip &lt;- inB 4     -&lt; 100</span>
<a name="line-347"></a><span class='hs-comment'>--     id -&lt; (sums, switchBlip)</span>
<a name="line-348"></a><span class='hs-comment'>--</span>
<a name="line-349"></a><span class='hs-comment'>-- -- alternatively</span>
<a name="line-350"></a><span class='hs-comment'>-- a1' = sumFrom 0 &amp;&amp;&amp; (tagBlips 100 . inB 4)</span>
<a name="line-351"></a><span class='hs-comment'>-- @</span>
<a name="line-352"></a><span class='hs-comment'>--</span>
<a name="line-353"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' (switchFromF (\x -&gt; (x,) &lt;$&gt; never) a1) [1..10]</span>
<a name="line-354"></a><span class='hs-comment'>-- [1,3,6,10,100,100,100,100,100,100]</span>
<a name="line-355"></a><span class='hs-comment'>--</span>
<a name="line-356"></a><span class='hs-comment'>-- @</span>
<a name="line-357"></a><span class='hs-comment'>-- a2 :: Auto' Int (Int, Blip ())</span>
<a name="line-358"></a><span class='hs-comment'>-- a2 = proc x -&gt; do</span>
<a name="line-359"></a><span class='hs-comment'>--     sums       &lt;- sumFrom 0 -&lt; x</span>
<a name="line-360"></a><span class='hs-comment'>--     switchBlip &lt;- inB 3     -&lt; ()</span>
<a name="line-361"></a><span class='hs-comment'>--     id -&lt; (sums, switchBlip)</span>
<a name="line-362"></a><span class='hs-comment'>--</span>
<a name="line-363"></a><span class='hs-comment'>-- -- alternatively</span>
<a name="line-364"></a><span class='hs-comment'>-- a2' = sumFrom 0 &amp;&amp;&amp; (tagBlips () . inB 3)</span>
<a name="line-365"></a><span class='hs-comment'>-- @</span>
<a name="line-366"></a><span class='hs-comment'>--</span>
<a name="line-367"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' (switchFromF (const a2) a2) [101..112]</span>
<a name="line-368"></a><span class='hs-comment'>-- [ 101, 203, 306  -- first 'sumFrom', on first three items [101, 102, 103]</span>
<a name="line-369"></a><span class='hs-comment'>-- , 104, 209, 315  -- second 'sumFrom', on second three items [104, 105, 106]</span>
<a name="line-370"></a><span class='hs-comment'>-- , 107, 215, 324  -- third 'sumFrom', on third three items [107, 108, 109]</span>
<a name="line-371"></a><span class='hs-comment'>-- , 110, 221, 333] -- final 'sumFrom', on fourth three items [110, 111, 112]</span>
<a name="line-372"></a><span class='hs-comment'>--</span>
<a name="line-373"></a><span class='hs-comment'>-- Or, if you're only ever going to use @a2@ in switching form:</span>
<a name="line-374"></a><span class='hs-comment'>--</span>
<a name="line-375"></a><span class='hs-comment'>-- @</span>
<a name="line-376"></a><span class='hs-comment'>-- a2s :: Auto' Int Int</span>
<a name="line-377"></a><span class='hs-comment'>-- a2s = switchFromF (const a2s) $ proc x -&gt; do</span>
<a name="line-378"></a><span class='hs-comment'>--           sums       &lt;- sumFrom 0 -&lt; x</span>
<a name="line-379"></a><span class='hs-comment'>--           switchBlip &lt;- inB 3     -&lt; ()</span>
<a name="line-380"></a><span class='hs-comment'>--           id -&lt; (c, swichBlip)</span>
<a name="line-381"></a><span class='hs-comment'>--</span>
<a name="line-382"></a><span class='hs-comment'>-- -- or</span>
<a name="line-383"></a><span class='hs-comment'>-- a2s' = switchFromF (const a2s')</span>
<a name="line-384"></a><span class='hs-comment'>--      $ sumFrom 0 &amp;&amp;&amp; (tagBlips () . inB 3)</span>
<a name="line-385"></a><span class='hs-comment'>-- @</span>
<a name="line-386"></a><span class='hs-comment'>--</span>
<a name="line-387"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a2s [101..112]</span>
<a name="line-388"></a><span class='hs-comment'>-- [101, 203, 306, 104, 209, 315, 107, 215, 324, 110, 221, 333]</span>
<a name="line-389"></a><span class='hs-comment'>--</span>
<a name="line-390"></a><span class='hs-comment'>-- As you can see, all of the simple examples from 'switchFrom_' can be</span>
<a name="line-391"></a><span class='hs-comment'>-- implemented in 'switchFromF'...and so can most real-life examples.  The</span>
<a name="line-392"></a><span class='hs-comment'>-- advantage is that 'switchFromF' is serializable, and 'switchFrom_' is</span>
<a name="line-393"></a><span class='hs-comment'>-- not.</span>
<a name="line-394"></a><span class='hs-comment'>--</span>
<a name="line-395"></a><span class='hs-comment'>-- Note that for the examples above, instead of using 'const', we could</span>
<a name="line-396"></a><span class='hs-comment'>-- have actually used the input parameter to create a new 'Auto' based on</span>
<a name="line-397"></a><span class='hs-comment'>-- what we outputted.</span>
<a name="line-398"></a><span class='hs-comment'>--</span>
<a name="line-399"></a><span class='hs-definition'>switchFromF</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Serialize</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-400"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ function to generate the</span>
<a name="line-401"></a>                                            <span class='hs-comment'>--   next 'Auto' to behave like</span>
<a name="line-402"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>         <span class='hs-comment'>-- ^ initial 'Auto'.  the @b@</span>
<a name="line-403"></a>                                            <span class='hs-comment'>--   is the output, and the</span>
<a name="line-404"></a>                                            <span class='hs-comment'>--   blip stream triggers new</span>
<a name="line-405"></a>                                            <span class='hs-comment'>--   'Auto's to replace this</span>
<a name="line-406"></a>                                            <span class='hs-comment'>--   one.</span>
<a name="line-407"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-408"></a><span class='hs-definition'>switchFromF</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Nothing</span>
<a name="line-409"></a>  <span class='hs-keyword'>where</span>
<a name="line-410"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span> <span class='hs-varid'>t</span>
<a name="line-411"></a>      <span class='hs-keyword'>where</span>
<a name="line-412"></a>        <span class='hs-varid'>s</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put</span> <span class='hs-varid'>mz</span>
<a name="line-413"></a>           <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a</span>
<a name="line-414"></a>        <span class='hs-varid'>t</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-415"></a>          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>ez</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span>
<a name="line-416"></a>          <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ez</span> <span class='hs-keyword'>of</span>
<a name="line-417"></a>            <span class='hs-conid'>Blip</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-418"></a>            <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span>       <span class='hs-varid'>a'</span>   <span class='hs-layout'>)</span>
<a name="line-419"></a>    <span class='hs-varid'>l</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-420"></a>      <span class='hs-varid'>mz</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-421"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mz</span> <span class='hs-keyword'>of</span>
<a name="line-422"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>z</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-423"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a</span>
<a name="line-424"></a>
<a name="line-425"></a><a name="switchFromF_"></a><span class='hs-comment'>-- | The non-serializing/non-resuming version of 'switchFromF'.  You sort</span>
<a name="line-426"></a><span class='hs-comment'>-- of might as well use 'switchFrom_'; this version might give rise to more</span>
<a name="line-427"></a><span class='hs-comment'>-- "disciplined" code, however, by being more restricted in power.</span>
<a name="line-428"></a><span class='hs-definition'>switchFromF_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-429"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ function to generate the</span>
<a name="line-430"></a>                                            <span class='hs-comment'>--   next 'Auto' to behave like</span>
<a name="line-431"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>        <span class='hs-comment'>-- ^ initial 'Auto'.  the @b@</span>
<a name="line-432"></a>                                            <span class='hs-comment'>--   is the output, and the</span>
<a name="line-433"></a>                                            <span class='hs-comment'>--   blip stream triggers new</span>
<a name="line-434"></a>                                            <span class='hs-comment'>--   'Auto's to replace this</span>
<a name="line-435"></a>                                            <span class='hs-comment'>--   one.</span>
<a name="line-436"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-437"></a><span class='hs-definition'>switchFromF_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-438"></a>                                 <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>ez</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>x</span>
<a name="line-439"></a>                                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ez</span> <span class='hs-keyword'>of</span>
<a name="line-440"></a>                                   <span class='hs-conid'>Blip</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchFromF_</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-441"></a>                                   <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchFromF_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a0'</span>  <span class='hs-layout'>)</span>
<a name="line-442"></a>
<a name="line-443"></a><a name="resetFrom"></a><span class='hs-comment'>-- | Gives an 'Auto' the ability to "reset" itself on command</span>
<a name="line-444"></a><span class='hs-comment'>--</span>
<a name="line-445"></a><span class='hs-comment'>-- Basically acts like @'fmap' 'fst'@</span>
<a name="line-446"></a><span class='hs-comment'>--</span>
<a name="line-447"></a><span class='hs-comment'>-- @</span>
<a name="line-448"></a><span class='hs-comment'>-- fmap fst :: Monad m =&gt; Auto m a (b, Blip c) -&gt; Auto m a b</span>
<a name="line-449"></a><span class='hs-comment'>-- @</span>
<a name="line-450"></a><span class='hs-comment'>--</span>
<a name="line-451"></a><span class='hs-comment'>-- But...whenever the blip stream emits..."resets" the 'Auto' back to the</span>
<a name="line-452"></a><span class='hs-comment'>-- original state, as if nothing ever happened.</span>
<a name="line-453"></a><span class='hs-comment'>--</span>
<a name="line-454"></a><span class='hs-comment'>-- Note that this resetting happens on the step /after/ the blip stream</span>
<a name="line-455"></a><span class='hs-comment'>-- emits.</span>
<a name="line-456"></a><span class='hs-comment'>--</span>
<a name="line-457"></a><span class='hs-comment'>-- Here is a summer that sends out a signal to reset itself whenever the</span>
<a name="line-458"></a><span class='hs-comment'>-- cumulative sum reaches 10 or higher:</span>
<a name="line-459"></a><span class='hs-comment'>--</span>
<a name="line-460"></a><span class='hs-comment'>-- @</span>
<a name="line-461"></a><span class='hs-comment'>-- limitSummer :: Auto' Int (Int, Blip ())</span>
<a name="line-462"></a><span class='hs-comment'>-- limitSummer = (id &amp;&amp;&amp; became (&gt;= 10)) . sumFrom 0</span>
<a name="line-463"></a><span class='hs-comment'>-- @</span>
<a name="line-464"></a><span class='hs-comment'>--</span>
<a name="line-465"></a><span class='hs-comment'>-- And now we throw it into 'resetFrom':</span>
<a name="line-466"></a><span class='hs-comment'>--</span>
<a name="line-467"></a><span class='hs-comment'>-- @</span>
<a name="line-468"></a><span class='hs-comment'>-- resettingSummer :: Auto' Int Int</span>
<a name="line-469"></a><span class='hs-comment'>-- resettingSummer = resetFrom limitSummer</span>
<a name="line-470"></a><span class='hs-comment'>-- @</span>
<a name="line-471"></a><span class='hs-comment'>--</span>
<a name="line-472"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' resettingSummer [1..10]</span>
<a name="line-473"></a><span class='hs-comment'>-- [ 1, 3, 6, 10    -- and...reset!</span>
<a name="line-474"></a><span class='hs-comment'>-- , 5, 11          -- and...reset!</span>
<a name="line-475"></a><span class='hs-comment'>-- , 7, 15          -- and...reset!</span>
<a name="line-476"></a><span class='hs-comment'>-- , 9, 19 ]</span>
<a name="line-477"></a><span class='hs-comment'>--</span>
<a name="line-478"></a><span class='hs-definition'>resetFrom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-479"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ The self-resetting 'Auto'</span>
<a name="line-480"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-481"></a><span class='hs-definition'>resetFrom</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchFromF</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>a'</span><span class='hs-layout'>)</span> <span class='hs-varid'>a'</span>
<a name="line-482"></a>  <span class='hs-keyword'>where</span>
<a name="line-483"></a>    <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>second</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagBlips</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>a</span>
<a name="line-484"></a>
<a name="line-485"></a><a name="switchOnF"></a><span class='hs-comment'>-- | Essentially identical to 'switchOn_', except instead of taking in</span>
<a name="line-486"></a><span class='hs-comment'>-- a blip stream of new 'Auto's to put into the box, takes a blip stream</span>
<a name="line-487"></a><span class='hs-comment'>-- of @c@ --- and 'switchOnF' uses the @c@ to create the new 'Auto' to put</span>
<a name="line-488"></a><span class='hs-comment'>-- in the box.</span>
<a name="line-489"></a><span class='hs-comment'>--</span>
<a name="line-490"></a><span class='hs-comment'>-- Here is the equivalent of the two examples from 'switchOn_',</span>
<a name="line-491"></a><span class='hs-comment'>-- implemented with 'switchOnF'; see the documentatino for 'switchOn_'</span>
<a name="line-492"></a><span class='hs-comment'>-- for a description of what they are to do.</span>
<a name="line-493"></a><span class='hs-comment'>--</span>
<a name="line-494"></a><span class='hs-comment'>-- @</span>
<a name="line-495"></a><span class='hs-comment'>-- newAuto :: Int -&gt; Auto' Int Int</span>
<a name="line-496"></a><span class='hs-comment'>-- newAuto 1 = sumFrom 0</span>
<a name="line-497"></a><span class='hs-comment'>-- newAuto 2 = productFrom 1</span>
<a name="line-498"></a><span class='hs-comment'>-- newAuto 3 = count</span>
<a name="line-499"></a><span class='hs-comment'>-- newAuto _ = error "Do you expect rigorous error handling from a toy example?"</span>
<a name="line-500"></a><span class='hs-comment'>--</span>
<a name="line-501"></a><span class='hs-comment'>-- a :: Auto' Int Int</span>
<a name="line-502"></a><span class='hs-comment'>-- a = proc i -&gt; do</span>
<a name="line-503"></a><span class='hs-comment'>--     blipAutos &lt;- eachAt 4 [1,2,3] -&lt; ()</span>
<a name="line-504"></a><span class='hs-comment'>--     switchOnF_ newAuto (pure 0) -&lt; (i, blipAutos)</span>
<a name="line-505"></a><span class='hs-comment'>-- @</span>
<a name="line-506"></a><span class='hs-comment'>--</span>
<a name="line-507"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a [1..12]</span>
<a name="line-508"></a><span class='hs-comment'>-- [ 1,  3,   6           -- output from sumFrom 0</span>
<a name="line-509"></a><span class='hs-comment'>-- , 4, 20, 120           -- output from productFrom 1</span>
<a name="line-510"></a><span class='hs-comment'>-- , 0,  1,   2, 3, 4, 5] -- output from count</span>
<a name="line-511"></a><span class='hs-comment'>--</span>
<a name="line-512"></a><span class='hs-comment'>-- Instead of sending in the "replacement 'Auto'", sends in a number, which</span>
<a name="line-513"></a><span class='hs-comment'>-- corresponds to a specific replacement 'Auto'.</span>
<a name="line-514"></a><span class='hs-comment'>--</span>
<a name="line-515"></a><span class='hs-comment'>-- As you can see, all of the simple examples from 'switchOn_' can be</span>
<a name="line-516"></a><span class='hs-comment'>-- implemented in 'switchOnF'...and so can most real-life examples.  The</span>
<a name="line-517"></a><span class='hs-comment'>-- advantage is that 'switchOnF' is serializable, and 'switchOn_' is</span>
<a name="line-518"></a><span class='hs-comment'>-- not.</span>
<a name="line-519"></a><span class='hs-comment'>--</span>
<a name="line-520"></a><span class='hs-definition'>switchOnF</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Serialize</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-521"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- ^ function to generate the next 'Auto'</span>
<a name="line-522"></a>                                  <span class='hs-comment'>--   to behave like</span>
<a name="line-523"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>           <span class='hs-comment'>-- ^ initial starting 'Auto' to behave</span>
<a name="line-524"></a>                                  <span class='hs-comment'>--   like</span>
<a name="line-525"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-526"></a><span class='hs-definition'>switchOnF</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Nothing</span>
<a name="line-527"></a>  <span class='hs-keyword'>where</span>
<a name="line-528"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span>
<a name="line-529"></a>    <span class='hs-varid'>l</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-530"></a>      <span class='hs-varid'>mz</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-531"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>mz</span> <span class='hs-keyword'>of</span>
<a name="line-532"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>z</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
<a name="line-533"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>resumeAuto</span> <span class='hs-varid'>a0</span>
<a name="line-534"></a>    <span class='hs-varid'>s</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>put</span> <span class='hs-varid'>mz</span>
<a name="line-535"></a>           <span class='hs-varop'>*&gt;</span> <span class='hs-varid'>saveAuto</span> <span class='hs-varid'>a0</span>
<a name="line-536"></a>    <span class='hs-varid'>t</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>ez</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-537"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>ez</span> <span class='hs-keyword'>of</span>
<a name="line-538"></a>        <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-539"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>x</span>
<a name="line-540"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>go</span> <span class='hs-varid'>mz</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span>
<a name="line-541"></a>        <span class='hs-conid'>Blip</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-542"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span>
<a name="line-543"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>
<a name="line-544"></a>
<a name="line-545"></a><a name="switchOnF_"></a><span class='hs-comment'>-- | The non-serializing/non-resuming version of 'switchOnF'. You sort of</span>
<a name="line-546"></a><span class='hs-comment'>-- might as well use 'switchOn_'; this version might give rise to more</span>
<a name="line-547"></a><span class='hs-comment'>-- "disciplined" code, however, by being more restricted in power.</span>
<a name="line-548"></a><span class='hs-definition'>switchOnF_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-549"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- ^ function to generate the next 'Auto'</span>
<a name="line-550"></a>                                  <span class='hs-comment'>--   to behave like</span>
<a name="line-551"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>          <span class='hs-comment'>-- ^ initial starting 'Auto' to behave</span>
<a name="line-552"></a>                                  <span class='hs-comment'>--   like</span>
<a name="line-553"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-554"></a><span class='hs-definition'>switchOnF_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAutoM_</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>ez</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-555"></a>                              <span class='hs-keyword'>case</span> <span class='hs-varid'>ez</span> <span class='hs-keyword'>of</span>
<a name="line-556"></a>                                <span class='hs-conid'>NoBlip</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-557"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-varid'>a0</span> <span class='hs-varid'>x</span>
<a name="line-558"></a>                                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchOnF_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a0'</span><span class='hs-layout'>)</span>
<a name="line-559"></a>                                <span class='hs-conid'>Blip</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-560"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepAuto</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span>
<a name="line-561"></a>                                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span> <span class='hs-varid'>switchOnF_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a1</span><span class='hs-layout'>)</span>
<a name="line-562"></a>
<a name="line-563"></a><a name="resetOn"></a><span class='hs-comment'>-- | Takes an innocent 'Auto' and wraps a "reset button" around it.  It</span>
<a name="line-564"></a><span class='hs-comment'>-- behaves just like the original 'Auto' at first, but when the input blip</span>
<a name="line-565"></a><span class='hs-comment'>-- stream emits, the internal 'Auto' is reset back to the beginning.</span>
<a name="line-566"></a><span class='hs-comment'>--</span>
<a name="line-567"></a><span class='hs-comment'>-- Here we have 'sumFrom' wrapped around a reset button, and we send</span>
<a name="line-568"></a><span class='hs-comment'>-- in a blip stream that emits every 4 steps; so every 4th step, the whole</span>
<a name="line-569"></a><span class='hs-comment'>-- summer resets.</span>
<a name="line-570"></a><span class='hs-comment'>--</span>
<a name="line-571"></a><span class='hs-comment'>-- &gt;&gt;&gt; let a = resetOn (sumFrom 0) . (id &amp;&amp;&amp; every 4)</span>
<a name="line-572"></a><span class='hs-comment'>-- &gt;&gt;&gt; streamAuto' a [101..112]</span>
<a name="line-573"></a><span class='hs-comment'>-- [ 101, 203, 306</span>
<a name="line-574"></a><span class='hs-comment'>-- , 104, 209, 315  -- resetted!</span>
<a name="line-575"></a><span class='hs-comment'>-- , 107, 215, 324  -- resetted!</span>
<a name="line-576"></a><span class='hs-comment'>-- , 110, 221, 333] -- resetted!</span>
<a name="line-577"></a><span class='hs-definition'>resetOn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span>
<a name="line-578"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>   <span class='hs-comment'>-- ^ 'Auto' to repeatedly reset</span>
<a name="line-579"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Auto</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Blip</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-580"></a><span class='hs-definition'>resetOn</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchOnF</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-varop'>.</span> <span class='hs-varid'>second</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagBlips</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
</pre></body>
</html>
